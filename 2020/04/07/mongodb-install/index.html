
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>MongoDB数据库部署-标准文档 | 寒枫的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="寒枫">
    

    
    <meta name="description" content="第一章 单机部署第一节 yum安装1.1 配置yum源1234567[root@mongo ~]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;mongodb.repo[mongodb-org-4.2]name&#x3D;MongoDB Repositorybaseurl&#x3D;https:&#x2F;&#x2F;repo.mongodb.org&#x2F;yum&#x2F;redhat&#x2F;$releasever&#x2F;mongodb-org&#x2F;4.2&#x2F;x86_6">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB数据库部署-标准文档">
<meta property="og:url" content="http://yoursite.com/2020/04/07/mongodb-install/index.html">
<meta property="og:site_name" content="寒枫的博客">
<meta property="og:description" content="第一章 单机部署第一节 yum安装1.1 配置yum源1234567[root@mongo ~]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;mongodb.repo[mongodb-org-4.2]name&#x3D;MongoDB Repositorybaseurl&#x3D;https:&#x2F;&#x2F;repo.mongodb.org&#x2F;yum&#x2F;redhat&#x2F;$releasever&#x2F;mongodb-org&#x2F;4.2&#x2F;x86_6">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-04-07T08:14:22.000Z">
<meta property="article:modified_time" content="2020-04-07T08:17:32.667Z">
<meta property="article:author" content="寒枫">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="寒枫的博客" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/%02.css">
<link rel="stylesheet" href="/.css">

<meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="寒枫的博客">寒枫的博客</a></h1>
				<h2 class="blog-motto">志存高远</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/categories/操作系统">系统</a></li>
					
						<li><a href="/categories/数据库">数据库</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/04/07/mongodb-install/" title="MongoDB数据库部署-标准文档" itemprop="url">MongoDB数据库部署-标准文档</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="寒枫" target="_blank" itemprop="author">寒枫</a>
		
  <p class="article-time">
    <time datetime="2020-04-07T08:14:22.000Z" itemprop="datePublished"> 发表于 2020-04-07</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h1 id="第一章-单机部署"><a href="#第一章-单机部署" class="headerlink" title="第一章 单机部署"></a>第一章 单机部署</h1><h2 id="第一节-yum安装"><a href="#第一节-yum安装" class="headerlink" title="第一节 yum安装"></a>第一节 yum安装</h2><h3 id="1-1-配置yum源"><a href="#1-1-配置yum源" class="headerlink" title="1.1 配置yum源"></a>1.1 配置yum源</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mongo</span> ~]<span class="comment"># vim /etc/yum.repos.d/mongodb.repo</span></span><br><span class="line">[<span class="type">mongodb</span>-<span class="type">org</span>-<span class="number">4.2</span>]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/<span class="variable">$releasever</span>/mongodb<span class="literal">-org</span>/<span class="number">4.2</span>/x86_64/</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgkey=https://www.mongodb.org/<span class="keyword">static</span>/pgp/server<span class="literal">-4</span>.<span class="number">2</span>.asc</span><br></pre></td></tr></table></figure>

<h3 id="1-2-安装mongo数据库"><a href="#1-2-安装mongo数据库" class="headerlink" title="1.2 安装mongo数据库"></a>1.2 安装mongo数据库</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mongo</span> ~]<span class="comment"># yum install mongodb-org -y</span></span><br><span class="line">Installing:</span><br><span class="line"> mongodb<span class="literal">-org</span>                         x86_64                  <span class="number">4.2</span>.<span class="number">3</span><span class="literal">-1</span>.el7                   mongodb<span class="literal">-org</span><span class="literal">-4</span>.<span class="number">2</span>                  <span class="number">5.8</span> k</span><br><span class="line">Installing <span class="keyword">for</span> dependencies:</span><br><span class="line"> mongodb<span class="literal">-org</span><span class="literal">-mongos</span>                  x86_64                  <span class="number">4.2</span>.<span class="number">3</span><span class="literal">-1</span>.el7                   mongodb<span class="literal">-org</span><span class="literal">-4</span>.<span class="number">2</span>                   <span class="number">14</span> M</span><br><span class="line"> mongodb<span class="literal">-org</span><span class="literal">-server</span>                  x86_64                  <span class="number">4.2</span>.<span class="number">3</span><span class="literal">-1</span>.el7                   mongodb<span class="literal">-org</span><span class="literal">-4</span>.<span class="number">2</span>                   <span class="number">25</span> M</span><br><span class="line"> mongodb<span class="literal">-org</span><span class="literal">-shell</span>                   x86_64                  <span class="number">4.2</span>.<span class="number">3</span><span class="literal">-1</span>.el7                   mongodb<span class="literal">-org</span><span class="literal">-4</span>.<span class="number">2</span>                   <span class="number">17</span> M</span><br><span class="line"> mongodb<span class="literal">-org</span><span class="literal">-tools</span>                   x86_64                  <span class="number">4.2</span>.<span class="number">3</span><span class="literal">-1</span>.el7                   mongodb<span class="literal">-org</span><span class="literal">-4</span>.<span class="number">2</span>                   <span class="number">62</span> M</span><br></pre></td></tr></table></figure>

<h3 id="1-3-禁用mongo自动升级"><a href="#1-3-禁用mongo自动升级" class="headerlink" title="1.3 禁用mongo自动升级"></a>1.3 禁用mongo自动升级</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/yum.conf</span></span><br><span class="line"><span class="comment">#在文件中加入下方配置</span></span><br><span class="line">exclude=mongodb<span class="literal">-org</span>,mongodb<span class="literal">-org</span><span class="literal">-server</span>,mongodb<span class="literal">-org</span><span class="literal">-shell</span>,mongodb<span class="literal">-org</span><span class="literal">-mongos</span>,mongodb<span class="literal">-org</span><span class="literal">-tools</span></span><br><span class="line">保存退出</span><br></pre></td></tr></table></figure>

<h3 id="1-4-mongo操作命令"><a href="#1-4-mongo操作命令" class="headerlink" title="1.4 mongo操作命令"></a>1.4 mongo操作命令</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">启动：</span><br><span class="line"><span class="comment"># systemctl start mongod</span></span><br><span class="line">重启：</span><br><span class="line"><span class="comment"># systemctl restart mongod</span></span><br><span class="line">关闭：</span><br><span class="line"><span class="comment"># systemctl stop mongod</span></span><br><span class="line">查看运行状态:</span><br><span class="line"><span class="comment"># systemctl status mongod</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-标准文件"><a href="#1-5-标准文件" class="headerlink" title="1.5 标准文件"></a>1.5 标准文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mongo</span> ~]<span class="comment"># cat /etc/mongod.conf </span></span><br><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /var/lib/mongo</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  <span class="comment"># fork and run in background</span></span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod.pid  <span class="comment"># location of pidfile</span></span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: <span class="number">27017</span></span><br><span class="line">  bindIp: <span class="number">127.0</span>.<span class="number">0.1</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mongo</span> ~]<span class="comment"># cat /usr/lib/systemd/system/mongod.service</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=MongoDB Database Server</span><br><span class="line">Documentation=https://docs.mongodb.org/manual</span><br><span class="line">After=network.target</span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">User=mongod</span><br><span class="line">Group=mongod</span><br><span class="line">Environment=<span class="string">"OPTIONS=-f /etc/mongod.conf"</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/mongod</span><br><span class="line">ExecStart=/usr/bin/mongod <span class="variable">$OPTIONS</span></span><br><span class="line">ExecStartPre=/usr/bin/mkdir <span class="literal">-p</span> /var/run/mongodb</span><br><span class="line">ExecStartPre=/usr/bin/chown mongod:mongod /var/run/mongodb</span><br><span class="line">ExecStartPre=/usr/bin/chmod <span class="number">0755</span> /var/run/mongodb</span><br><span class="line">PermissionsStartOnly=true</span><br><span class="line">PIDFile=/var/run/mongodb/mongod.pid</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># file size</span></span><br><span class="line">LimitFSIZE=infinity</span><br><span class="line"><span class="comment"># cpu time</span></span><br><span class="line">LimitCPU=infinity</span><br><span class="line"><span class="comment"># virtual memory size</span></span><br><span class="line">LimitAS=infinity</span><br><span class="line"><span class="comment"># open files</span></span><br><span class="line">LimitNOFILE=<span class="number">64000</span></span><br><span class="line"><span class="comment"># processes/threads</span></span><br><span class="line">LimitNPROC=<span class="number">64000</span></span><br><span class="line"><span class="comment"># locked memory</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line"><span class="comment"># total threads (user+kernel)</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line">TasksAccounting=false</span><br><span class="line"><span class="comment"># Recommended limits for for mongod as specified in</span></span><br><span class="line"><span class="comment"># http://docs.mongodb.org/manual/reference/ulimit/#recommended-settings</span></span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br></pre></td></tr></table></figure>



<h2 id="第二节-预编译安装"><a href="#第二节-预编译安装" class="headerlink" title="第二节 预编译安装"></a>第二节 预编译安装</h2><h1 id="第二章-集群部署"><a href="#第二章-集群部署" class="headerlink" title="第二章 集群部署"></a>第二章 集群部署</h1><h2 id="第一节-基础配置"><a href="#第一节-基础配置" class="headerlink" title="第一节 基础配置"></a>第一节 基础配置</h2><h3 id="1-1-基础环境"><a href="#1-1-基础环境" class="headerlink" title="1.1 基础环境"></a>1.1 基础环境</h3><table>
<thead>
<tr>
<th>IP地址</th>
<th>主机名称</th>
<th>系统版本</th>
<th>数据库版本</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.56.131</td>
<td>mgs01.cjspd.local</td>
<td>CentOS7.6_x86_64</td>
<td>MongoDB4.2.3</td>
</tr>
<tr>
<td>192.168.56.132</td>
<td>mgs02.cjspd.local</td>
<td>CentOS7.6_x86_64</td>
<td>MongoDB4.2.3</td>
</tr>
<tr>
<td>192.168.56.133</td>
<td>mgs03.cjspd.local</td>
<td>CentOS7.6_x86_64</td>
<td>MongoDB4.2.3</td>
</tr>
</tbody></table>
<h3 id="1-2-系统环境"><a href="#1-2-系统环境" class="headerlink" title="1.2 系统环境"></a>1.2 系统环境</h3><table>
<thead>
<tr>
<th align="center">IP地址</th>
<th align="center">主机名</th>
<th align="center">路由服务端口</th>
<th align="center">配置服务端口</th>
<th align="center">分片1端口</th>
<th align="center">分片2端口</th>
<th align="center">分片3端口</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.56.131</td>
<td align="center">mgs01.cjspd.local</td>
<td align="center">27017</td>
<td align="center">27018</td>
<td align="center">27001</td>
<td align="center">27002</td>
<td align="center">27003</td>
</tr>
<tr>
<td align="center">192.168.56.132</td>
<td align="center">mgs02.cjspd.local</td>
<td align="center">27017</td>
<td align="center">27018</td>
<td align="center">27001</td>
<td align="center">27002</td>
<td align="center">27003</td>
</tr>
<tr>
<td align="center">192.168.56.133</td>
<td align="center">mgs03.cjspd.local</td>
<td align="center">27017</td>
<td align="center">27018</td>
<td align="center">27001</td>
<td align="center">27002</td>
<td align="center">27003</td>
</tr>
</tbody></table>
<h3 id="1-3-目录规划"><a href="#1-3-目录规划" class="headerlink" title="1.3 目录规划"></a>1.3 目录规划</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、MongoDB数据库安装目录</span><br><span class="line">/usr/local/mongodb</span><br><span class="line"><span class="number">2</span>、数据库文件与日志文件，配置文件目录</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># tree /data</span></span><br><span class="line">/<span class="keyword">data</span></span><br><span class="line">└── mongodb</span><br><span class="line">    ├── conf			<span class="comment">#配置文件目录</span></span><br><span class="line">    ├── <span class="keyword">data</span>			<span class="comment">#数据库文件根目录</span></span><br><span class="line">    │   ├── config		<span class="comment">#配置服务数据目录</span></span><br><span class="line">    │   ├── shard1		<span class="comment">#分片1服务数据目录</span></span><br><span class="line">    │   └── shard2		<span class="comment">#分片2服务数据目录</span></span><br><span class="line">    │   └── shard3		<span class="comment">#分片3服务数据目录</span></span><br><span class="line">    └── logs			<span class="comment">#日志文件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-开通防火墙"><a href="#1-4-开通防火墙" class="headerlink" title="1.4 开通防火墙"></a>1.4 开通防火墙</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=27017/tcp --permanent</span></span><br><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=27018/tcp --permanent</span></span><br><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=27001/tcp --permanent</span></span><br><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=27002/tcp --permanent</span></span><br><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=27003/tcp --permanent</span></span><br><span class="line"><span class="comment"># firewalld-cmd --reload</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-主机名配置"><a href="#1-5-主机名配置" class="headerlink" title="1.5 主机名配置"></a>1.5 主机名配置</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--主机名配置</span><br><span class="line"><span class="comment"># hostnamectl set-hostname mgs01.cjspd.local</span></span><br><span class="line"><span class="comment"># hostnamectl set-hostname mgs02.cjspd.local</span></span><br><span class="line"><span class="comment"># hostnamectl set-hostname mgs03.cjspd.local</span></span><br><span class="line">--本地解析配置</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">56.131</span> mgs01.cjspd.local</span><br><span class="line"><span class="number">192.168</span>.<span class="number">56.132</span> mgs02.cjspd.local</span><br><span class="line"><span class="number">192.168</span>.<span class="number">56.133</span> mgs03.cjspd.local</span><br></pre></td></tr></table></figure>



<h2 id="第二节-数据库安装"><a href="#第二节-数据库安装" class="headerlink" title="第二节 数据库安装"></a>第二节 数据库安装</h2><h3 id="2-1-创建用户和组"><a href="#2-1-创建用户和组" class="headerlink" title="2.1 创建用户和组"></a>2.1 创建用户和组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">home</span>]<span class="comment"># groupadd mongod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">home</span>]<span class="comment"># useradd -g mongod mongod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">home</span>]<span class="comment"># id mongod</span></span><br><span class="line">uid=<span class="number">1001</span>(mongod) gid=<span class="number">1001</span>(mongod) groups=<span class="number">1001</span>(mongod)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-解压缩软件"><a href="#2-2-解压缩软件" class="headerlink" title="2.2 解压缩软件"></a>2.2 解压缩软件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">setup</span>]<span class="comment"># tar -zxvf mongodb-linux-x86_64-rhel70-4.2.3.tgz -C /usr/local</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">setup</span>]<span class="comment"># cd /usr/local</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># ll</span></span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span>  <span class="number">3</span> root root <span class="number">135</span> Mar <span class="number">13</span> <span class="number">22</span>:<span class="number">58</span> mongodb<span class="literal">-linux</span><span class="literal">-x86_64</span><span class="literal">-rhel70</span><span class="literal">-4</span>.<span class="number">2.3</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># ln -s /usr/local/mongodb-linux-x86_64-rhel70-4.2.3 mongodb</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># ll</span></span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> root root  <span class="number">44</span> Mar <span class="number">13</span> <span class="number">22</span>:<span class="number">59</span> mongodb -&gt; /usr/local/mongodb<span class="literal">-linux</span><span class="literal">-x86_64</span><span class="literal">-rhel70</span><span class="literal">-4</span>.<span class="number">2.3</span></span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span>  <span class="number">3</span> root root <span class="number">135</span> Mar <span class="number">13</span> <span class="number">22</span>:<span class="number">58</span> mongodb<span class="literal">-linux</span><span class="literal">-x86_64</span><span class="literal">-rhel70</span><span class="literal">-4</span>.<span class="number">2.3</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-配置环境变量"><a href="#2-3-配置环境变量" class="headerlink" title="2.3 配置环境变量"></a>2.3 配置环境变量</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># echo "export PATH=$PATH:/usr/local/mongodb/bin"&gt;&gt;/etc/profile</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>

<h2 id="第三节-复制集部署"><a href="#第三节-复制集部署" class="headerlink" title="第三节 复制集部署"></a>第三节 复制集部署</h2><h3 id="3-1-创建目录文件"><a href="#3-1-创建目录文件" class="headerlink" title="3.1 创建目录文件"></a>3.1 创建目录文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">-<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">131</span>服务器操作</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/&#123;conf,data,logs&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/data/&#123;config,shard1,shard2&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># touch /data/mongodb/logs/&#123;config.log,mongos.log,shard1.log,shard2.log&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># tree /data</span></span><br><span class="line">/<span class="keyword">data</span></span><br><span class="line">└── mongodb</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── <span class="keyword">data</span></span><br><span class="line">    │   ├── config</span><br><span class="line">    │   ├── shard1</span><br><span class="line">    │   └── shard2</span><br><span class="line">    └── logs</span><br><span class="line">        ├── config.log</span><br><span class="line">        ├── mongos.log</span><br><span class="line">        ├── shard1.log</span><br><span class="line">        └── shard2.log</span><br><span class="line">-<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">132</span>服务器操作</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/&#123;conf,data,logs&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/data/&#123;config,shard1,shard2&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">local</span>]<span class="comment"># touch /data/mongodb/logs/&#123;config.log,mongos.log,shard1.log,shard2.log&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">local</span>]<span class="comment"># tree /data</span></span><br><span class="line">/<span class="keyword">data</span></span><br><span class="line">└── mongodb</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── <span class="keyword">data</span></span><br><span class="line">    │   ├── config</span><br><span class="line">    │   ├── shard1</span><br><span class="line">    │   └── shard2</span><br><span class="line">    └── logs</span><br><span class="line">        ├── config.log</span><br><span class="line">        ├── mongos.log</span><br><span class="line">        ├── shard1.log</span><br><span class="line">        └── shard2.log</span><br><span class="line">-<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">133</span>服务器操作</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/&#123;conf,data,logs&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">local</span>]<span class="comment"># mkdir -p /data/mongodb/data/&#123;config,shard1,shard2&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">local</span>]<span class="comment"># touch /data/mongodb/logs/&#123;config.log,mongos.log,shard1.log,shard2.log&#125;</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">local</span>]<span class="comment"># tree /data</span></span><br><span class="line">/<span class="keyword">data</span></span><br><span class="line">└── mongodb</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── <span class="keyword">data</span></span><br><span class="line">    │   ├── config</span><br><span class="line">    │   ├── shard1</span><br><span class="line">    │   └── shard2</span><br><span class="line">    └── logs</span><br><span class="line">        ├── config.log</span><br><span class="line">        ├── mongos.log</span><br><span class="line">        ├── shard1.log</span><br><span class="line">        └── shard2.log</span><br></pre></td></tr></table></figure>

<h3 id="3-2-配置服务部署"><a href="#3-2-配置服务部署" class="headerlink" title="3.2 配置服务部署"></a>3.2 配置服务部署</h3><p><strong>① 创建配置文件</strong></p>
<p>三台服务器执行相同操作</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/config.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/config</span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/config.log</span><br><span class="line">port=<span class="number">27018</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#复制集名称</span></span><br><span class="line">replSet=configs</span><br><span class="line"><span class="comment">#置参数为true</span></span><br><span class="line">configsvr=true</span><br><span class="line"><span class="comment">#允许任意机器连接</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<p>②<strong>启动配置服务</strong></p>
<p>分别启动三台服务器的配置服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">--启动MongoDB的配置服务（<span class="number">192.168</span>.<span class="number">56.131</span>）</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">bin</span>]<span class="comment"># /usr/local/mongodb/bin/mongod -f /data/mongodb/conf/config.conf</span></span><br><span class="line">or</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">bin</span>]<span class="comment"># mongod -f /data/mongodb/conf/config.conf</span></span><br><span class="line">about to fork child <span class="keyword">process</span>, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked <span class="keyword">process</span>: <span class="number">2109</span></span><br><span class="line">child <span class="keyword">process</span> started successfully, parent exiting</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">bin</span>]<span class="comment"># ps -ef|grep mongo</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">bin</span>]<span class="comment"># ps -ef|grep mongo</span></span><br><span class="line">root       <span class="number">2109</span>      <span class="number">1</span> <span class="number">12</span> <span class="number">23</span>:<span class="number">26</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> /usr/local/mongodb/bin/mongod <span class="operator">-f</span> /<span class="keyword">data</span>/mongodb/conf/config.conf</span><br><span class="line">root       <span class="number">2156</span>   <span class="number">1959</span>  <span class="number">0</span> <span class="number">23</span>:<span class="number">26</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto mongo</span><br><span class="line">--启动MongoDB的配置服务（<span class="number">192.168</span>.<span class="number">56.132</span>）</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">logs</span>]<span class="comment"># mongod -f /data/mongodb/conf/config.conf</span></span><br><span class="line">about to fork child <span class="keyword">process</span>, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked <span class="keyword">process</span>: <span class="number">2105</span></span><br><span class="line">child <span class="keyword">process</span> started successfully, parent exiting</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">logs</span>]<span class="comment"># ps -ef|grep mongo</span></span><br><span class="line">root       <span class="number">2105</span>      <span class="number">1</span> <span class="number">20</span> <span class="number">23</span>:<span class="number">27</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> mongod <span class="operator">-f</span> /<span class="keyword">data</span>/mongodb/conf/config.conf</span><br><span class="line">root       <span class="number">2150</span>   <span class="number">1956</span>  <span class="number">0</span> <span class="number">23</span>:<span class="number">27</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto mongo</span><br><span class="line">--启动MongoDB的配置服务（<span class="number">192.168</span>.<span class="number">56.133</span>）</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">logs</span>]<span class="comment"># mongod -f /data/mongodb/conf/config.conf</span></span><br><span class="line">about to fork child <span class="keyword">process</span>, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked <span class="keyword">process</span>: <span class="number">2109</span></span><br><span class="line">child <span class="keyword">process</span> started successfully, parent exiting</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">logs</span>]<span class="comment"># ps -ef|grep mongo</span></span><br><span class="line">root       <span class="number">2109</span>      <span class="number">1</span> <span class="number">23</span> <span class="number">23</span>:<span class="number">27</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> mongod <span class="operator">-f</span> /<span class="keyword">data</span>/mongodb/conf/config.conf</span><br><span class="line">root       <span class="number">2153</span>   <span class="number">1953</span>  <span class="number">0</span> <span class="number">23</span>:<span class="number">28</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto mongo</span><br></pre></td></tr></table></figure>

<p><strong>③配置复制集</strong></p>
<p>连接任意一台服务器即可</p>
<p>记得所有服务器关闭防火墙</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">bin</span>]<span class="comment"># mongo --host 192.168.56.131 --port 27018</span></span><br><span class="line">--切换数据库</span><br><span class="line">&gt; use admin;</span><br><span class="line">switched to db admin</span><br><span class="line">--初始化复制集</span><br><span class="line">&gt; rs.initiate(&#123;_id:<span class="string">"configs"</span>,members:[&#123;<span class="type">_id</span>:<span class="number">0</span>,<span class="type">host</span>:<span class="string">"192.168.56.131:27018"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">1</span>,<span class="type">host</span>:<span class="string">"192.168.56.132:27018"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">2</span>,<span class="type">host</span>:<span class="string">"192.168.56.133:27018"</span>&#125;]&#125;)</span><br><span class="line">--其中_id:<span class="string">"configs"</span>的configs是上面config.conf配置文件里的复制集名称，把三台服务器的配置服务组成复制集。</span><br><span class="line">--查看状态：</span><br><span class="line">configs:SECONDARY&gt; rs.status();</span><br></pre></td></tr></table></figure>

<h3 id="3-3-分片服务部署"><a href="#3-3-分片服务部署" class="headerlink" title="3.3 分片服务部署"></a>3.3 分片服务部署</h3><p><strong>①创建配置文件</strong></p>
<p>分别在三台服务器操作</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">---------<span class="literal">-mgs01</span><span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">131</span></span><br><span class="line">--分片服务器shard1</span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard1.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard1.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27001</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">--分片服务器shard2</span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard2.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard2.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27002</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">---------<span class="literal">-mgs01</span><span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">132</span></span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard1.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard1.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27001</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">--分片服务器shard2</span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard2.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard2.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27002</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">---------<span class="literal">-mgs01</span><span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">133</span></span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard1.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard1.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27001</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">--分片服务器shard2</span><br><span class="line"><span class="comment"># vim /data/mongodb/conf/shard2.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard2.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27002</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#storageEngine=mmapv1</span></span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<p><strong>②启动分片服务</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-------<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">131</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard1.conf</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard2.conf</span></span><br><span class="line">-------<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">132</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard1.conf</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard2.conf</span></span><br><span class="line">-------<span class="literal">-192</span>.<span class="number">168.56</span>.<span class="number">133</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard1.conf</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> <span class="type">conf</span>]<span class="comment"># mongod -f /data/mongodb/conf/shard2.conf</span></span><br></pre></td></tr></table></figure>

<p><strong>③配置复制集</strong></p>
<p>连接任意一台服务器即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---<span class="literal">-shard1</span>分片服务器</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">data</span>]<span class="comment"># mongo --host 192.168.56.131 --port 27001</span></span><br><span class="line">--切换数据库</span><br><span class="line">&gt; use admin;</span><br><span class="line">--初始化复制集</span><br><span class="line">&gt; rs.initiate(&#123;_id:<span class="string">"shard1"</span>,members:[&#123;<span class="type">_id</span>:<span class="number">0</span>,<span class="type">host</span>:<span class="string">"192.168.56.131:27001"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">1</span>,<span class="type">host</span>:<span class="string">"192.168.56.132:27001"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">2</span>,<span class="type">host</span>:<span class="string">"192.168.56.133:27001"</span>&#125;]&#125;)</span><br><span class="line">---<span class="literal">-shard2</span>分片服务器</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">data</span>]<span class="comment"># mongo --host 192.168.56.132 --port 27002</span></span><br><span class="line">&gt; rs.initiate(&#123;_id:<span class="string">"shard2"</span>,members:[&#123;<span class="type">_id</span>:<span class="number">0</span>,<span class="type">host</span>:<span class="string">"192.168.56.131:27002"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">1</span>,<span class="type">host</span>:<span class="string">"192.168.56.132:27002"</span>&#125;,&#123;<span class="type">_id</span>:<span class="number">2</span>,<span class="type">host</span>:<span class="string">"192.168.56.133:27002"</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-路由服务器"><a href="#3-4-路由服务器" class="headerlink" title="3.4 路由服务器"></a>3.4 路由服务器</h3><p>路由服务部署(3台服务器执行相同操作)</p>
<p><strong>① 创建配置文件</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/mongos.conf</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/mongos.log</span><br><span class="line">logappend = true</span><br><span class="line">port = <span class="number">27017</span></span><br><span class="line">fork = true</span><br><span class="line">configdb = configs/<span class="number">192.168</span>.<span class="number">56.131</span>:<span class="number">27018</span>,<span class="number">192.168</span>.<span class="number">56.132</span>:<span class="number">27018</span>,<span class="number">192.168</span>.<span class="number">56.133</span>:<span class="number">27018</span></span><br><span class="line">maxConns=<span class="number">20000</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<p><strong>② 启动mongos服务</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">data</span>]<span class="comment"># mongos -f /data/mongodb/conf/mongos.conf</span></span><br></pre></td></tr></table></figure>

<p><strong>③ 启动分片服务</strong></p>
<p>连接mongo：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">data</span>]<span class="comment"># mongo --host 192.168.56.131 --port 27017</span></span><br><span class="line">--切换数据库：</span><br><span class="line">mongos&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">--添加分片，只需在一台机器执行即可：</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"shard1/192.168.56.131:27001,192.168.56.132:27001,192.168.56.133:27001"</span>);</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"shardAdded"</span> : <span class="string">"shard1"</span>,</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(<span class="number">1584116955</span>, <span class="number">6</span>),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(<span class="number">1584116955</span>, <span class="number">6</span>),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(<span class="number">0</span>,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">添加另一个分片</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"shard2/192.168.56.131:27002,192.168.56.132:27002,192.168.56.133:27002"</span>);</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"shardAdded"</span> : <span class="string">"shard1"</span>,</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(<span class="number">1584275052</span>, <span class="number">1</span>),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(<span class="number">1584275052</span>, <span class="number">1</span>),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(<span class="number">0</span>,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--查看集群状态</span><br><span class="line">mongos&gt; sh.status();</span><br></pre></td></tr></table></figure>

<h2 id="第四节-系统测试"><a href="#第四节-系统测试" class="headerlink" title="第四节 系统测试"></a>第四节 系统测试</h2><h3 id="4-1-分片测试"><a href="#4-1-分片测试" class="headerlink" title="4.1 分片测试"></a>4.1 分片测试</h3><p>1）登录到router 实例</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mongo --port 27017</span></span><br></pre></td></tr></table></figure>

<p>2）开启分片功能</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">-- 对库cjspd开启分片</span><br><span class="line">mongos&gt; db.runCommand(&#123;<span class="string">"enablesharding"</span>:<span class="string">"cjspd"</span>&#125;)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(<span class="number">1584337660</span>, <span class="number">4</span>),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(<span class="number">1584337660</span>, <span class="number">4</span>),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(<span class="number">0</span>,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">-- 对库llh 下的表person 按字段ID 配置hash 分库算法</span><br><span class="line">mongos&gt; db.runCommand(&#123;<span class="string">"shardcollection"</span>:<span class="string">"cjspd.person"</span>,<span class="string">"key"</span>:&#123;_id:<span class="string">'hashed'</span>&#125;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"collectionsharded"</span> : <span class="string">"cjspd.person"</span>,</span><br><span class="line">        <span class="string">"collectionUUID"</span> : UUID(<span class="string">"6410f33a-2f93-44e0-b6a0-7f38754fb54d"</span>),</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(<span class="number">1584337734</span>, <span class="number">26</span>),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(<span class="number">1584337734</span>, <span class="number">26</span>),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(<span class="number">0</span>,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）插入数据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">mongos&gt;  <span class="keyword">for</span>(var i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;db.person.insert(&#123;name:<span class="string">"chenh"</span>+i&#125;);&#125;</span><br><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>4）校验数据分片</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">****分库结果校验</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> ~]<span class="comment"># mongo --port 27001</span></span><br><span class="line">-<span class="literal">-PRIMARY</span>库查询</span><br><span class="line">shard1:PRIMARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard1:PRIMARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3c"</span>), <span class="string">"name"</span> : <span class="string">"chenh0"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3d"</span>), <span class="string">"name"</span> : <span class="string">"chenh1"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d46"</span>), <span class="string">"name"</span> : <span class="string">"chenh10"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d47"</span>), <span class="string">"name"</span> : <span class="string">"chenh11"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d49"</span>), <span class="string">"name"</span> : <span class="string">"chenh13"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4c"</span>), <span class="string">"name"</span> : <span class="string">"chenh16"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4e"</span>), <span class="string">"name"</span> : <span class="string">"chenh18"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4f"</span>), <span class="string">"name"</span> : <span class="string">"chenh19"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d50"</span>), <span class="string">"name"</span> : <span class="string">"chenh20"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d51"</span>), <span class="string">"name"</span> : <span class="string">"chenh21"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d52"</span>), <span class="string">"name"</span> : <span class="string">"chenh22"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d54"</span>), <span class="string">"name"</span> : <span class="string">"chenh24"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d56"</span>), <span class="string">"name"</span> : <span class="string">"chenh26"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d57"</span>), <span class="string">"name"</span> : <span class="string">"chenh27"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d58"</span>), <span class="string">"name"</span> : <span class="string">"chenh28"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d59"</span>), <span class="string">"name"</span> : <span class="string">"chenh29"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5a"</span>), <span class="string">"name"</span> : <span class="string">"chenh30"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5c"</span>), <span class="string">"name"</span> : <span class="string">"chenh32"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5e"</span>), <span class="string">"name"</span> : <span class="string">"chenh34"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d60"</span>), <span class="string">"name"</span> : <span class="string">"chenh36"</span> &#125;</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> ~]<span class="comment"># mongo --port 27002</span></span><br><span class="line">shard2:PRIMARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard2:PRIMARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3e"</span>), <span class="string">"name"</span> : <span class="string">"chenh2"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3f"</span>), <span class="string">"name"</span> : <span class="string">"chenh3"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d40"</span>), <span class="string">"name"</span> : <span class="string">"chenh4"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d41"</span>), <span class="string">"name"</span> : <span class="string">"chenh5"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d42"</span>), <span class="string">"name"</span> : <span class="string">"chenh6"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d43"</span>), <span class="string">"name"</span> : <span class="string">"chenh7"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d44"</span>), <span class="string">"name"</span> : <span class="string">"chenh8"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d45"</span>), <span class="string">"name"</span> : <span class="string">"chenh9"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d48"</span>), <span class="string">"name"</span> : <span class="string">"chenh12"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4a"</span>), <span class="string">"name"</span> : <span class="string">"chenh14"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4b"</span>), <span class="string">"name"</span> : <span class="string">"chenh15"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4d"</span>), <span class="string">"name"</span> : <span class="string">"chenh17"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d53"</span>), <span class="string">"name"</span> : <span class="string">"chenh23"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d55"</span>), <span class="string">"name"</span> : <span class="string">"chenh25"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5b"</span>), <span class="string">"name"</span> : <span class="string">"chenh31"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5d"</span>), <span class="string">"name"</span> : <span class="string">"chenh33"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5f"</span>), <span class="string">"name"</span> : <span class="string">"chenh35"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d64"</span>), <span class="string">"name"</span> : <span class="string">"chenh40"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d65"</span>), <span class="string">"name"</span> : <span class="string">"chenh41"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d68"</span>), <span class="string">"name"</span> : <span class="string">"chenh44"</span> &#125;</span><br></pre></td></tr></table></figure>

<p>5）校验复制集同步</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">******复制集校验（shard1）</span><br><span class="line">-<span class="literal">-SECONDARY</span>库查看</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> ~]<span class="comment"># mongo --port 27001</span></span><br><span class="line">shard1:SECONDARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard1:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">shard1:SECONDARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3c"</span>), <span class="string">"name"</span> : <span class="string">"chenh0"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3d"</span>), <span class="string">"name"</span> : <span class="string">"chenh1"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d46"</span>), <span class="string">"name"</span> : <span class="string">"chenh10"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d47"</span>), <span class="string">"name"</span> : <span class="string">"chenh11"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d49"</span>), <span class="string">"name"</span> : <span class="string">"chenh13"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4c"</span>), <span class="string">"name"</span> : <span class="string">"chenh16"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4e"</span>), <span class="string">"name"</span> : <span class="string">"chenh18"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4f"</span>), <span class="string">"name"</span> : <span class="string">"chenh19"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d51"</span>), <span class="string">"name"</span> : <span class="string">"chenh21"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d50"</span>), <span class="string">"name"</span> : <span class="string">"chenh20"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d52"</span>), <span class="string">"name"</span> : <span class="string">"chenh22"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d56"</span>), <span class="string">"name"</span> : <span class="string">"chenh26"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d54"</span>), <span class="string">"name"</span> : <span class="string">"chenh24"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d59"</span>), <span class="string">"name"</span> : <span class="string">"chenh29"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d57"</span>), <span class="string">"name"</span> : <span class="string">"chenh27"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d58"</span>), <span class="string">"name"</span> : <span class="string">"chenh28"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5a"</span>), <span class="string">"name"</span> : <span class="string">"chenh30"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5c"</span>), <span class="string">"name"</span> : <span class="string">"chenh32"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5e"</span>), <span class="string">"name"</span> : <span class="string">"chenh34"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d60"</span>), <span class="string">"name"</span> : <span class="string">"chenh36"</span> &#125;</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> ~]<span class="comment"># mongo --port 27001</span></span><br><span class="line">shard1:SECONDARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard1:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">shard1:SECONDARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3c"</span>), <span class="string">"name"</span> : <span class="string">"chenh0"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3d"</span>), <span class="string">"name"</span> : <span class="string">"chenh1"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d46"</span>), <span class="string">"name"</span> : <span class="string">"chenh10"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d47"</span>), <span class="string">"name"</span> : <span class="string">"chenh11"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d49"</span>), <span class="string">"name"</span> : <span class="string">"chenh13"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4c"</span>), <span class="string">"name"</span> : <span class="string">"chenh16"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4e"</span>), <span class="string">"name"</span> : <span class="string">"chenh18"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4f"</span>), <span class="string">"name"</span> : <span class="string">"chenh19"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d50"</span>), <span class="string">"name"</span> : <span class="string">"chenh20"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d51"</span>), <span class="string">"name"</span> : <span class="string">"chenh21"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d52"</span>), <span class="string">"name"</span> : <span class="string">"chenh22"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d54"</span>), <span class="string">"name"</span> : <span class="string">"chenh24"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d56"</span>), <span class="string">"name"</span> : <span class="string">"chenh26"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d58"</span>), <span class="string">"name"</span> : <span class="string">"chenh28"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d57"</span>), <span class="string">"name"</span> : <span class="string">"chenh27"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d59"</span>), <span class="string">"name"</span> : <span class="string">"chenh29"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5a"</span>), <span class="string">"name"</span> : <span class="string">"chenh30"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5c"</span>), <span class="string">"name"</span> : <span class="string">"chenh32"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5e"</span>), <span class="string">"name"</span> : <span class="string">"chenh34"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d60"</span>), <span class="string">"name"</span> : <span class="string">"chenh36"</span> &#125;</span><br><span class="line">******复制集校验（shard2）</span><br><span class="line">-<span class="literal">-SECONDARY</span>库查看</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs02</span> ~]<span class="comment"># mongo --port 27002</span></span><br><span class="line">shard1:SECONDARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard1:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">shard1:SECONDARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3e"</span>), <span class="string">"name"</span> : <span class="string">"chenh2"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d40"</span>), <span class="string">"name"</span> : <span class="string">"chenh4"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3f"</span>), <span class="string">"name"</span> : <span class="string">"chenh3"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d41"</span>), <span class="string">"name"</span> : <span class="string">"chenh5"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d42"</span>), <span class="string">"name"</span> : <span class="string">"chenh6"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d43"</span>), <span class="string">"name"</span> : <span class="string">"chenh7"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d44"</span>), <span class="string">"name"</span> : <span class="string">"chenh8"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d45"</span>), <span class="string">"name"</span> : <span class="string">"chenh9"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d48"</span>), <span class="string">"name"</span> : <span class="string">"chenh12"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4a"</span>), <span class="string">"name"</span> : <span class="string">"chenh14"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4b"</span>), <span class="string">"name"</span> : <span class="string">"chenh15"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4d"</span>), <span class="string">"name"</span> : <span class="string">"chenh17"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d53"</span>), <span class="string">"name"</span> : <span class="string">"chenh23"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d55"</span>), <span class="string">"name"</span> : <span class="string">"chenh25"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5b"</span>), <span class="string">"name"</span> : <span class="string">"chenh31"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5d"</span>), <span class="string">"name"</span> : <span class="string">"chenh33"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5f"</span>), <span class="string">"name"</span> : <span class="string">"chenh35"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d64"</span>), <span class="string">"name"</span> : <span class="string">"chenh40"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d65"</span>), <span class="string">"name"</span> : <span class="string">"chenh41"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d68"</span>), <span class="string">"name"</span> : <span class="string">"chenh44"</span> &#125;</span><br><span class="line">-<span class="literal">-SECONDARY</span>库查看</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs03</span> ~]<span class="comment"># mongo --port 27002</span></span><br><span class="line">shard1:SECONDARY&gt; use cjspd</span><br><span class="line">switched to db cjspd</span><br><span class="line">shard1:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">shard1:SECONDARY&gt; db.person.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3e"</span>), <span class="string">"name"</span> : <span class="string">"chenh2"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d40"</span>), <span class="string">"name"</span> : <span class="string">"chenh4"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d3f"</span>), <span class="string">"name"</span> : <span class="string">"chenh3"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d41"</span>), <span class="string">"name"</span> : <span class="string">"chenh5"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d43"</span>), <span class="string">"name"</span> : <span class="string">"chenh7"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d42"</span>), <span class="string">"name"</span> : <span class="string">"chenh6"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d45"</span>), <span class="string">"name"</span> : <span class="string">"chenh9"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d44"</span>), <span class="string">"name"</span> : <span class="string">"chenh8"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d48"</span>), <span class="string">"name"</span> : <span class="string">"chenh12"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4a"</span>), <span class="string">"name"</span> : <span class="string">"chenh14"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4b"</span>), <span class="string">"name"</span> : <span class="string">"chenh15"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d4d"</span>), <span class="string">"name"</span> : <span class="string">"chenh17"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d53"</span>), <span class="string">"name"</span> : <span class="string">"chenh23"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d55"</span>), <span class="string">"name"</span> : <span class="string">"chenh25"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5b"</span>), <span class="string">"name"</span> : <span class="string">"chenh31"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5d"</span>), <span class="string">"name"</span> : <span class="string">"chenh33"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d5f"</span>), <span class="string">"name"</span> : <span class="string">"chenh35"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d64"</span>), <span class="string">"name"</span> : <span class="string">"chenh40"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d65"</span>), <span class="string">"name"</span> : <span class="string">"chenh41"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5e6f137fd87da0f642fe9d68"</span>), <span class="string">"name"</span> : <span class="string">"chenh44"</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-临时命令"><a href="#4-2-临时命令" class="headerlink" title="4.2 临时命令"></a>4.2 临时命令</h3><p><strong>④ 实现分片功能</strong></p>
<p>设置分片chunk大小        </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">db.setting.save(&#123;<span class="string">"_id"</span>:<span class="string">"chunksize"</span>,<span class="string">"value"</span>:<span class="number">1</span>&#125;) <span class="comment"># 设置块大小为1M是方便实验，不然需要插入海量数据</span></span><br></pre></td></tr></table></figure>




<p>5、模拟写入数据        </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use calon</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=<span class="number">50000</span>;i++)&#123;db.user.insert(&#123;<span class="string">"id"</span>:i,<span class="string">"name"</span>:<span class="string">"jack"</span>+i&#125;)&#125; <span class="comment">#模拟往calon数据库的user表写入5万数据</span></span><br></pre></td></tr></table></figure>



<p>7、启用数据库分片</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.enableSharding(<span class="string">"calon"</span>)</span><br></pre></td></tr></table></figure>

<p>8、创建索引，对表进行分片        </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.user.createIndex(&#123;<span class="string">"id"</span>:<span class="number">1</span>&#125;) <span class="comment"># 以"id"作为索引</span></span><br><span class="line">sh.shardCollection(calon.user<span class="string">",&#123;"</span>id<span class="string">":1&#125;) # 根据"</span>id<span class="string">"对user表进行分片</span></span><br><span class="line"><span class="string">sh.status() # 查看分片情况</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-故障模拟"><a href="#4-3-故障模拟" class="headerlink" title="4.3 故障模拟"></a>4.3 故障模拟</h3><p>1）配置服务故障模拟</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">--模拟故障前状态</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mongo --port 27018</span></span><br><span class="line">configs:PRIMARY&gt; rs.status();</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.132:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,     </span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.133:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">--模拟关闭PRIMARY节点</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mongod -f /data/mongodb/conf/config.conf --shutdown</span></span><br><span class="line">killing <span class="keyword">process</span> with pid: <span class="number">4589</span></span><br><span class="line">--结果检查</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">local</span>]<span class="comment"># mongo --port 27018</span></span><br><span class="line">configs:PRIMARY&gt; rs.status()</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">1</span>,</span><br><span class="line">        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">8</span>,</span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.132:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.133:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">--服务启动后，节点恢复为SECONDARY状态</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27018"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br></pre></td></tr></table></figure>

<p>2）分片服务故障模拟</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">--模拟故障前状态</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> <span class="type">local</span>]<span class="comment"># mongo --port 27001</span></span><br><span class="line">shard1:PRIMARY&gt; rs.status();</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.132:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line"></span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.133:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">--模拟关闭PRIMARY节点</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> ~]<span class="comment"># mongod -f /data/mongodb/conf/shard1.conf --shutdown</span></span><br><span class="line">killing <span class="keyword">process</span> with pid: <span class="number">4705</span></span><br><span class="line">--结果检查</span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> <span class="type">local</span>]<span class="comment"># mongo --port 27001</span></span><br><span class="line">shard1:PRIMARY&gt; rs.status</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">8</span>,</span><br><span class="line"></span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.132:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        </span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.133:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line"></span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">--服务启动后，节点恢复为SECONDARY状态</span><br><span class="line">[<span class="type">root</span>@<span class="type">mgs01</span> ~]<span class="comment"># mongod -f /data/mongodb/conf/shard1.conf</span></span><br><span class="line">about to fork child <span class="keyword">process</span>, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked <span class="keyword">process</span>: <span class="number">25826</span></span><br><span class="line">child <span class="keyword">process</span> started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.131:27001"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br></pre></td></tr></table></figure>

<h2 id="第五节-配置系统服务"><a href="#第五节-配置系统服务" class="headerlink" title="第五节 配置系统服务"></a>第五节 配置系统服务</h2><h3 id="5-1-路由服务"><a href="#5-1-路由服务" class="headerlink" title="5.1 路由服务"></a>5.1 路由服务</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /lib/systemd/system/mongos.service</span></span><br><span class="line">[<span class="type">Unit</span>]</span><br><span class="line">Description=MongoDB Database of Service mongos</span><br><span class="line">After=network.target remote<span class="literal">-fs</span>.target nss<span class="literal">-lookup</span>.target</span><br><span class="line">PID=<span class="variable">$</span>(cat /var/run/mongos.pid)</span><br><span class="line">[<span class="type">Service</span>]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># PIDFile=/var/run/mongodb/mongod.pid</span></span><br><span class="line">ExecStart=mongos -<span class="literal">-config</span> /<span class="keyword">data</span>/mongodb/conf/mongos.conf</span><br><span class="line">ExecStop=kill <span class="variable">$PID</span></span><br><span class="line">PrivateTmp=false</span><br><span class="line"></span><br><span class="line">[<span class="type">Install</span>]</span><br><span class="line">WantedBy=multi<span class="literal">-user</span>.target</span><br><span class="line">--启动服务</span><br><span class="line"><span class="comment"># systemctl start mongos</span></span><br><span class="line"><span class="comment"># systemctl stop mongos</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-配置服务"><a href="#5-2-配置服务" class="headerlink" title="5.2 配置服务"></a>5.2 配置服务</h3><h3 id="5-3-分片服务"><a href="#5-3-分片服务" class="headerlink" title="5.3 分片服务"></a>5.3 分片服务</h3><p>到此，MongoDB分布式集群就搭建完毕。</p>
<h2 id="第六节-参考配置"><a href="#第六节-参考配置" class="headerlink" title="第六节 参考配置"></a>第六节 参考配置</h2><h3 id="6-1-配置文件"><a href="#6-1-配置文件" class="headerlink" title="6.1 配置文件"></a>6.1 配置文件</h3><h4 id="config-conf"><a href="#config-conf" class="headerlink" title="config.conf"></a>config.conf</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/config.conf</span></span><br><span class="line">dbpath=/home/mongodb/<span class="keyword">data</span>/config</span><br><span class="line">logpath=/home/mongodb/log/config.log</span><br><span class="line">port=<span class="number">27018</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line"><span class="comment">#复制集名称</span></span><br><span class="line">replSet=configs</span><br><span class="line"><span class="comment">#置参数为true</span></span><br><span class="line">configsvr=true</span><br><span class="line"><span class="comment">#允许任意机器连接</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="mongos-conf"><a href="#mongos-conf" class="headerlink" title="mongos.conf"></a>mongos.conf</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/mongos.conf</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/mongos.log</span><br><span class="line">logappend = true</span><br><span class="line">port = <span class="number">27017</span></span><br><span class="line">fork = true</span><br><span class="line">configdb = configs/<span class="number">192.168</span>.<span class="number">56.131</span>:<span class="number">27018</span>,<span class="number">192.168</span>.<span class="number">56.132</span>:<span class="number">27018</span>,<span class="number">192.168</span>.<span class="number">56.133</span>:<span class="number">27018</span></span><br><span class="line">maxConns=<span class="number">20000</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="shard1-conf"><a href="#shard1-conf" class="headerlink" title="shard1.conf"></a>shard1.conf</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/shard1.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard1.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27001</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="shard2-conf"><a href="#shard2-conf" class="headerlink" title="shard2.conf"></a>shard2.conf</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/mongodb/conf/shard2.conf</span></span><br><span class="line">dbpath=/<span class="keyword">data</span>/mongodb/<span class="keyword">data</span>/shard2 <span class="comment">#其他2个分片对应修改为shard2、shard3文件夹</span></span><br><span class="line">logpath=/<span class="keyword">data</span>/mongodb/logs/shard2.log <span class="comment">#其他2个分片对应修改为shard2.log、shard3.log</span></span><br><span class="line">port=<span class="number">27002</span> <span class="comment">#其他2个分片对应修改为27002、27003</span></span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=<span class="number">5000</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">shardsvr=true</span><br><span class="line">replSet=shard1 <span class="comment">#其他2个分片对应修改为shard2、shard3</span></span><br><span class="line">bind_ip=<span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-安装指令"><a href="#6-2-安装指令" class="headerlink" title="6.2 安装指令"></a>6.2 安装指令</h3><p>添加分片</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.A:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0000"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.B:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0001"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.C:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0002"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>



<h1 id="第三章-数据库管理"><a href="#第三章-数据库管理" class="headerlink" title="第三章 数据库管理"></a>第三章 数据库管理</h1><h2 id="第一节-分片管理"><a href="#第一节-分片管理" class="headerlink" title="第一节 分片管理"></a>第一节 分片管理</h2><h3 id="1-添加分片"><a href="#1-添加分片" class="headerlink" title="1.添加分片"></a>1.添加分片</h3><p><strong>sh.addShard(“IP:Port”)</strong> </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.A:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0000"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.B:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0001"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">mongos&gt; sh.addShard(<span class="string">"192.168.200.C:40000"</span>) <span class="comment">#添加分片</span></span><br><span class="line">&#123; <span class="string">"shardAdded"</span> : <span class="string">"shard0002"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(<span class="string">"shard1/192.168.56.131:27001,192.168.56.132:27001,192.168.56.133:27001"</span>);</span><br></pre></td></tr></table></figure>



<h3 id="2-开启分片"><a href="#2-开启分片" class="headerlink" title="2.开启分片"></a>2.开启分片</h3><p><strong>sh.enableSharding(“库名”)、sh.shardCollection(“库名.集合名”,{“key”:1})</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(<span class="string">"dba"</span>)</span><br><span class="line">&#123; <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line"></span><br><span class="line">mongos&gt; sh.shardCollection(<span class="string">"dba.account"</span>,&#123;<span class="string">"name"</span>:<span class="number">1</span>&#125;)</span><br><span class="line">&#123; <span class="string">"collectionsharded"</span> : <span class="string">"dba.account"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-查看分片状态"><a href="#3-查看分片状态" class="headerlink" title="3.查看分片状态"></a>3.查看分片状态</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status ---...</span><br><span class="line">  shards:</span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"shard0000"</span>,  <span class="string">"host"</span> : <span class="string">"192.168.200.A:40000"</span> &#125;</span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"shard0001"</span>,  <span class="string">"host"</span> : <span class="string">"192.168.200.B:40000"</span> &#125;</span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"shard0002"</span>,  <span class="string">"host"</span> : <span class="string">"192.168.200.C:40000"</span> &#125;</span><br><span class="line">...</span><br><span class="line">  databases:  <span class="comment">#库</span></span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"admin"</span>,  <span class="string">"partitioned"</span> : false,  <span class="string">"primary"</span> : <span class="string">"config"</span> &#125;</span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"test"</span>,  <span class="string">"partitioned"</span> : false,  <span class="string">"primary"</span> : <span class="string">"shard0000"</span> &#125;</span><br><span class="line">    &#123;  <span class="string">"_id"</span> : <span class="string">"dba"</span>,  <span class="string">"partitioned"</span> : true,  <span class="string">"primary"</span> : <span class="string">"shard0000"</span> &#125; <span class="comment">#允许分片</span></span><br><span class="line">        dba.account   <span class="comment">#dba下的分片集合</span></span><br><span class="line">            shard key: &#123; <span class="string">"name"</span> : <span class="number">1</span> &#125;                             </span><br><span class="line">            chunks:   <span class="comment">#块信息</span></span><br><span class="line">                shard0000    <span class="number">1</span></span><br><span class="line">            &#123; <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125; &#125; --&gt;&gt; &#123; <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : <span class="number">1</span> &#125; &#125; on : shard0000 Timestamp(<span class="number">1</span>, <span class="number">0</span>)  <span class="comment">#块里数据的范围</span></span><br></pre></td></tr></table></figure>

<h3 id="4-分片信息"><a href="#4-分片信息" class="headerlink" title="4.分片信息"></a>4.分片信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.shards.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"shard0000"</span>, <span class="string">"host"</span> : <span class="string">"192.168.200.51:40000"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"shard0001"</span>, <span class="string">"host"</span> : <span class="string">"192.168.200.52:40000"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"shard0002"</span>, <span class="string">"host"</span> : <span class="string">"192.168.200.53:40000"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"mablevi"</span>, <span class="string">"host"</span> : <span class="string">"mablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002"</span> &#125; <span class="comment">#副本级分片，不需要把所有的节点写出</span></span><br></pre></td></tr></table></figure>

<p><strong>分片中所有数据库信息：config.databases</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.databases.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"admin"</span>, <span class="string">"partitioned"</span> : false, <span class="string">"primary"</span> : <span class="string">"config"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"test"</span>, <span class="string">"partitioned"</span> : false, <span class="string">"primary"</span> : <span class="string">"shard0001"</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"dba"</span>, <span class="string">"partitioned"</span> : true, <span class="string">"primary"</span> : <span class="string">"shard0000"</span> &#125;  <span class="comment">#分片</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"abc"</span>, <span class="string">"partitioned"</span> : true, <span class="string">"primary"</span> : <span class="string">"shard0000"</span> &#125;  <span class="comment">#分片</span></span><br></pre></td></tr></table></figure>

<p><strong>分片集合信息：config.collections</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.collections.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"lastmod"</span> : ISODate(<span class="string">"2015-07-14T15:12:29.706Z"</span>),</span><br><span class="line">    <span class="string">"dropped"</span> : false,</span><br><span class="line">    <span class="string">"key"</span> : &#123;          <span class="comment">#片键</span></span><br><span class="line">        <span class="string">"name"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"unique"</span> : false,  <span class="comment">#片键是否唯一</span></span><br><span class="line">    <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mongos路由的信息：config.mongs 。可以查看所有mongos的状态</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.mongos.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo2:30000"</span>,</span><br><span class="line">    <span class="string">"ping"</span> : ISODate(<span class="string">"2015-07-27T03:13:06.178Z"</span>),</span><br><span class="line">    <span class="string">"up"</span> : <span class="number">323671</span>,      <span class="comment">#活着时间</span></span><br><span class="line">    <span class="string">"waiting"</span> : true, </span><br><span class="line">    <span class="string">"mongoVersion"</span> : <span class="string">"3.0.4"</span> <span class="comment">#版本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>均衡器锁的信息：config.locks，记录所有集群范围的锁，可得知哪个mongos是均衡器。</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.locks.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"balancer"</span>,   <span class="comment">#均衡器</span></span><br><span class="line">    <span class="string">"state"</span> : <span class="number">1</span>,          <span class="comment">#0非活动状态、1尝试得到锁，但还没得到，2表示正在进行均衡</span></span><br><span class="line">    <span class="string">"who"</span> : <span class="string">"mongo1:30000:1436888525:1804289383:Balancer:846930886"</span>, <span class="comment">#哪个mongos当均衡器</span></span><br><span class="line">    <span class="string">"ts"</span> : ObjectId(<span class="string">"55b5a2d5fdd9a605a039f951"</span>),</span><br><span class="line">    <span class="string">"process"</span> : <span class="string">"mongo1:30000:1436888525:1804289383"</span>,</span><br><span class="line">    <span class="string">"when"</span> : ISODate(<span class="string">"2015-07-27T03:17:41.159Z"</span>),</span><br><span class="line">    <span class="string">"why"</span> : <span class="string">"doing balance round"</span> <span class="comment">#均衡导致锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>记录所有块的信息：config.chunks，也可以通过sh.status()查看</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.chunks.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"dba.account-name_MinKey"</span>,   <span class="comment">#标识符</span></span><br><span class="line">    <span class="string">"lastmod"</span> : Timestamp(<span class="number">2</span>, <span class="number">0</span>),         <span class="comment">#块的版本</span></span><br><span class="line">    <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>), <span class="comment">#块的版本</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,    <span class="comment">#集合名</span></span><br><span class="line">    <span class="string">"min"</span> : &#123;                <span class="comment">#数据范围</span></span><br><span class="line">        <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max"</span> : &#123;</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"shard"</span> : <span class="string">"mablevi"</span>      <span class="comment">#所在分片</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"dba.account-name_\"</span><span class="number">9</span>XXqCaBhfhPIXLq\<span class="string">""</span>,</span><br><span class="line">    <span class="string">"lastmod"</span> : Timestamp(<span class="number">4</span>, <span class="number">0</span>),</span><br><span class="line">    <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>),</span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"min"</span> : &#123;</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max"</span> : &#123;</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"RWINvgjYYQmbZds"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"shard"</span> : <span class="string">"shard0002"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>记录所有的分片操作：config.changelog，拆分、迁移</strong></p>
<p><strong>拆分：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:40-55a526e8f0432675a473009c"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:40.375Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"multi-split"</span>,  <span class="comment">#拆分</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;            <span class="comment">#拆分先后的信息</span></span><br><span class="line">        <span class="string">"before"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;        <span class="comment">#拆分前范围</span></span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"number"</span> : <span class="number">1</span>,   <span class="comment">#第一个块</span></span><br><span class="line">        <span class="string">"of"</span> : <span class="number">3</span>,       <span class="comment">#拆分成3个块</span></span><br><span class="line">        <span class="string">"chunk"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"lastmod"</span> : Timestamp(<span class="number">1</span>, <span class="number">1</span>), <span class="comment">#版本号</span></span><br><span class="line">            <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:40-55a526e8f0432675a473009d"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:40.378Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"multi-split"</span>,</span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"before"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"number"</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">"of"</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">"chunk"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"okmjUUZuuKgftDC"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"lastmod"</span> : Timestamp(<span class="number">1</span>, <span class="number">2</span>), <span class="comment">#版本号</span></span><br><span class="line">            <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:40-55a526e8f0432675a473009e"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:40.381Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"multi-split"</span>,</span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"before"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"number"</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">"of"</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">"chunk"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"okmjUUZuuKgftDC"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"max"</span> : &#123;</span><br><span class="line">                <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"lastmod"</span> : Timestamp(<span class="number">1</span>, <span class="number">3</span>),  <span class="comment">#版本号</span></span><br><span class="line">            <span class="string">"lastmodEpoch"</span> : ObjectId(<span class="string">"55a526dd511d36716224fb77"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>迁移：</strong>4个文档</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:41-55a526e9f0432675a47300a1"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:41.406Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"moveChunk.start"</span>,  <span class="comment">#迁移开始</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"min"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"max"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"from"</span> : <span class="string">"shard0000"</span>,</span><br><span class="line">        <span class="string">"to"</span> : <span class="string">"mablevi"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo3-2015-07-14T15:12:42-55a526ead5bee637c12aadd4"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo3"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">":27017"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:42.419Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"moveChunk.to"</span>,   <span class="comment">#from分片</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"min"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"max"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"step 1 of 5"</span> : <span class="number">327</span>,  <span class="comment">#耗时，单位毫秒。检查命令参数</span></span><br><span class="line">        <span class="string">"step 2 of 5"</span> : <span class="number">301</span>,  <span class="comment">#申请分布锁</span></span><br><span class="line">        <span class="string">"step 3 of 5"</span> : <span class="number">1</span>,    <span class="comment">#连接到to分片</span></span><br><span class="line">        <span class="string">"step 4 of 5"</span> : <span class="number">0</span>,    <span class="comment">#数据复制，每个分片都是直接和另一个分片、配置服务器直接连接</span></span><br><span class="line">        <span class="string">"step 5 of 5"</span> : <span class="number">407</span>,  <span class="comment">#和to分片、配置服务器确认是否完成</span></span><br><span class="line">        <span class="string">"note"</span> : <span class="string">"success"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:42-55a526eaf0432675a47300a2"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:42.854Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"moveChunk.commit"</span>,  <span class="comment">#提交</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"min"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"max"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"from"</span> : <span class="string">"shard0000"</span>,</span><br><span class="line">        <span class="string">"to"</span> : <span class="string">"mablevi"</span>,</span><br><span class="line">        <span class="string">"cloned"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="string">"clonedBytes"</span> : NumberLong(<span class="number">94</span>),</span><br><span class="line">        <span class="string">"catchup"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">        <span class="string">"steady"</span> : NumberLong(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : <span class="string">"mongo1-2015-07-14T15:12:43-55a526ebf0432675a47300a3"</span>,</span><br><span class="line">    <span class="string">"server"</span> : <span class="string">"mongo1"</span>,</span><br><span class="line">    <span class="string">"clientAddr"</span> : <span class="string">"192.168.200.52:53257"</span>,</span><br><span class="line">    <span class="string">"time"</span> : ISODate(<span class="string">"2015-07-14T15:12:43.258Z"</span>),</span><br><span class="line">    <span class="string">"what"</span> : <span class="string">"moveChunk.from"</span>,  <span class="comment">#to分片</span></span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"dba.account"</span>,</span><br><span class="line">    <span class="string">"details"</span> : &#123;</span><br><span class="line">        <span class="string">"min"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : <span class="number">1</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"max"</span> : &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"9XXqCaBhfhPIXLq"</span></span><br><span class="line">        &#125;,    <span class="comment">#步骤的时间为毫秒</span></span><br><span class="line">        <span class="string">"step 1 of 6"</span> : <span class="number">0</span>,      <span class="comment">#迁移索引 </span></span><br><span class="line">        <span class="string">"step 2 of 6"</span> : <span class="number">613</span>,    <span class="comment">#删除块内的数据，清理数据残余</span></span><br><span class="line">        <span class="string">"step 3 of 6"</span> : <span class="number">2</span>,      <span class="comment">#文档复制到to分片</span></span><br><span class="line">        <span class="string">"step 4 of 6"</span> : <span class="number">1029</span>,   <span class="comment">#复制期间，在to分片上执行操作</span></span><br><span class="line">        <span class="string">"step 5 of 6"</span> : <span class="number">415</span>,    <span class="comment">#等待to分片将新迁移过来的数据复制到集群</span></span><br><span class="line">        <span class="string">"step 6 of 6"</span> : <span class="number">0</span>,      <span class="comment">#修改元数据完成迁移</span></span><br><span class="line"><span class="string">"to"</span> : <span class="string">"mablevi"</span>,</span><br><span class="line">        <span class="string">"from"</span> : <span class="string">"shard0000"</span>,</span><br><span class="line">        <span class="string">"note"</span> : <span class="string">"success"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分片标签：config.tags，sh.addShardTag</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.tags.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">        <span class="string">"ns"</span> : <span class="string">"abc.number"</span>,</span><br><span class="line">        <span class="string">"min"</span> : &#123;</span><br><span class="line">            <span class="string">"num"</span> : <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"ns"</span> : <span class="string">"abc.number"</span>,</span><br><span class="line">    <span class="string">"min"</span> : &#123;</span><br><span class="line">        <span class="string">"num"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max"</span> : &#123;</span><br><span class="line">        <span class="string">"num"</span> : <span class="number">20</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"tag"</span> : <span class="string">"AAA"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分片设置：config.settings，设置分片块的大小和开启关闭均衡器</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.settings.find()</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"chunksize"</span>, <span class="string">"value"</span> : <span class="number">32</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"balancer"</span>, <span class="string">"stopped"</span> : false &#125;</span><br></pre></td></tr></table></figure>

<p><strong>网络连接数： db.adminCommand({“connPoolStats”:1})</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.adminCommand(&#123;<span class="string">"connPoolStats"</span>:<span class="number">1</span>&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"hosts"</span> : &#123;</span><br><span class="line">        <span class="string">"192.168.200.51:20000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:20000::30"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:20000,192.168.200.51:21000,192.168.200.51:22000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:20000,192.168.200.51:21000,192.168.200.51:22000::30"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">3</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">422</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:21000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:21000::30"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:22000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:22000::30"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.51:40000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">2</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.52:40000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">4</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:40000::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:50000::5"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:50001::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:50001::5"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:50002::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"192.168.200.53:50002::5"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"mablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002::0"</span> : &#123;</span><br><span class="line">            <span class="string">"available"</span> : <span class="number">2</span>,</span><br><span class="line">            <span class="string">"created"</span> : <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"replicaSets"</span> : &#123;</span><br><span class="line">        <span class="string">"mablevi"</span> : &#123;</span><br><span class="line">            <span class="string">"hosts"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"addr"</span> : <span class="string">"192.168.200.53:50000"</span>,</span><br><span class="line">                    <span class="string">"ok"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"ismaster"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"hidden"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"secondary"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"pingTimeMillis"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"addr"</span> : <span class="string">"192.168.200.53:50001"</span>,</span><br><span class="line">                    <span class="string">"ok"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"ismaster"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"hidden"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"secondary"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"pingTimeMillis"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"addr"</span> : <span class="string">"192.168.200.53:50002"</span>,</span><br><span class="line">                    <span class="string">"ok"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"ismaster"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"hidden"</span> : <span class="type">false</span>,</span><br><span class="line">                    <span class="string">"secondary"</span> : <span class="type">true</span>,</span><br><span class="line">                    <span class="string">"pingTimeMillis"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"createdByType"</span> : &#123;</span><br><span class="line">        <span class="string">"master"</span> : <span class="number">22</span>,</span><br><span class="line">        <span class="string">"set"</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">"sync"</span> : <span class="number">423</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"totalAvailable"</span> : <span class="number">21</span>,   <span class="comment">#总的可用连接</span></span><br><span class="line">    <span class="string">"totalCreated"</span> : <span class="number">448</span>,   <span class="comment">#总创建的连接</span></span><br><span class="line">    <span class="string">"numDBClientConnection"</span> : <span class="number">40</span>,</span><br><span class="line">    <span class="string">"numAScopedConnection"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>拆分块管理</strong></p>
<p>mongos记录每个块中插入多少数据，一旦达到某个阈值，就会检查是否需要拆分块，需要则更新配置服务器上这个块的元信息。具体过程：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">① 客户端发起请求，mongos检查当前块的阈值点。</span><br><span class="line"></span><br><span class="line">② 达到拆分的阈值点，mongos向分片发起一个拆分请求。</span><br><span class="line"></span><br><span class="line">③ 分片计算拆分点，将信息发回给mongos。</span><br><span class="line"></span><br><span class="line">④ mongos选择一个拆分点，将这些信息发给配置服务器。</span><br></pre></td></tr></table></figure>


  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2020/04/07/mongodb-install/" data-title="MongoDB数据库部署-标准文档 | 寒枫的博客" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2020/04/07/mongodb-manage/" title="MongoDB系统管理-标准文档">
  <strong>上一篇：</strong><br/>
  <span>
  MongoDB系统管理-标准文档</span>
</a>
</div>


<div class="next">
<a href="/2020/04/07/MySQL/"  title="MySQL系统管理-标准文档">
 <strong>下一篇：</strong><br/> 
 <span>MySQL系统管理-标准文档
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第一章-单机部署"><span class="toc-number">1.</span> <span class="toc-text">第一章 单机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一节-yum安装"><span class="toc-number">1.1.</span> <span class="toc-text">第一节 yum安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-配置yum源"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 配置yum源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-安装mongo数据库"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 安装mongo数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-禁用mongo自动升级"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 禁用mongo自动升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-mongo操作命令"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 mongo操作命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-标准文件"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5 标准文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二节-预编译安装"><span class="toc-number">1.2.</span> <span class="toc-text">第二节 预编译安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第二章-集群部署"><span class="toc-number">2.</span> <span class="toc-text">第二章 集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一节-基础配置"><span class="toc-number">2.1.</span> <span class="toc-text">第一节 基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-基础环境"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 基础环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-系统环境"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 系统环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-目录规划"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 目录规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-开通防火墙"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4 开通防火墙</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-主机名配置"><span class="toc-number">2.1.5.</span> <span class="toc-text">1.5 主机名配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二节-数据库安装"><span class="toc-number">2.2.</span> <span class="toc-text">第二节 数据库安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-创建用户和组"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 创建用户和组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-解压缩软件"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 解压缩软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-配置环境变量"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3 配置环境变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第三节-复制集部署"><span class="toc-number">2.3.</span> <span class="toc-text">第三节 复制集部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-创建目录文件"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 创建目录文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-配置服务部署"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 配置服务部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-分片服务部署"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 分片服务部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-路由服务器"><span class="toc-number">2.3.4.</span> <span class="toc-text">3.4 路由服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第四节-系统测试"><span class="toc-number">2.4.</span> <span class="toc-text">第四节 系统测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-分片测试"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 分片测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-临时命令"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 临时命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-故障模拟"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3 故障模拟</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第五节-配置系统服务"><span class="toc-number">2.5.</span> <span class="toc-text">第五节 配置系统服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-路由服务"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1 路由服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-配置服务"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 配置服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-分片服务"><span class="toc-number">2.5.3.</span> <span class="toc-text">5.3 分片服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第六节-参考配置"><span class="toc-number">2.6.</span> <span class="toc-text">第六节 参考配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-配置文件"><span class="toc-number">2.6.1.</span> <span class="toc-text">6.1 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#config-conf"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">config.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mongos-conf"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">mongos.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shard1-conf"><span class="toc-number">2.6.1.3.</span> <span class="toc-text">shard1.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shard2-conf"><span class="toc-number">2.6.1.4.</span> <span class="toc-text">shard2.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-安装指令"><span class="toc-number">2.6.2.</span> <span class="toc-text">6.2 安装指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第三章-数据库管理"><span class="toc-number">3.</span> <span class="toc-text">第三章 数据库管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一节-分片管理"><span class="toc-number">3.1.</span> <span class="toc-text">第一节 分片管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-添加分片"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.添加分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-开启分片"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.开启分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-查看分片状态"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.查看分片状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-分片信息"><span class="toc-number">3.1.4.</span> <span class="toc-text">4.分片信息</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/操作系统/" title="操作系统">操作系统<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>4</sup></a></li>
		  
		
		</ul>
</div>


  

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://sina.comc.cn" target="_blank" title="一个面向程序员交流分享的新一代社区">新浪网</a>
            
          </li>
        
          <li>
            
            	<a href="https://baidu.com" target="_blank" title="百度">百度</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> Hello ,I&#39;m hanyist Page in Google. <br/>
			</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="寒枫">寒枫</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
